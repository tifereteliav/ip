import React, { useState } from 'react';
import { 
  Heart, 
  Smartphone, 
  Activity, 
  Settings, 
  CheckCircle, 
  AlertCircle, 
  ChevronRight, 
  ChevronLeft,
  Droplet,
  BatteryCharging
} from 'lucide-react';

// --- DATA & LOGIC ---

// Pump Definitions based on Panther File
const PUMPS = {
  medtronic: {
    id: 'medtronic',
    name: 'MiniMed 780G',
    tagline: 'המתקנת האוטומטית',
    description: 'מערכת עם תיקון אוטומטי אגרסיבי (כל 5 דקות). מתאימה למי שרוצה שהמשאבה תעבוד קשה בשבילו למניעת גבוהים.',
    pros: [
      'תיקון אוטומטי מלא (בזאל + בולוס) כל 5 דקות',
      'מצויינת למניעת היפרגליקמיה (סוכר גבוה)',
      'עובדת עם סנסור Guardian 4 / Simplera (לא דורש כיולים)'
    ],
    cons: [
      'מחייבת שימוש בסנסור של מדטרוניק בלבד',
      'פחות שליטה מהטלפון הנייד (בעיקר צפייה)',
      'דורשת ספירת פחמימות'
    ]
  },
  tandem: {
    id: 'tandem',
    name: 'Tandem t:slim X2 / Mobi',
    tagline: 'המתאימה אישית',
    description: 'גמישות מלאה ושליטה. אלגוריתם Control-IQ שצופה קדימה ומצב שינה ייעודי.',
    pros: [
      'מגוון סנסורים (Dexcom, Libre 2+)',
      'שליטה מלאה מהנייד (בדגם Mobi ואפליקציית t:connect)',
      'מצב שינה (Sleep Mode) לשמירה הדוקה בלילה',
      'קטנה מאוד (Mobi)'
    ],
    cons: [
      'תיקון אוטומטי (בולוס) רק פעם בשעה (אך מגבירה בזאל)',
      'דורשת ספירת פחמימות'
    ]
  },
  omnipod: {
    id: 'omnipod',
    name: 'Omnipod 5',
    tagline: 'החופשייה מצינורות',
    description: 'משאבת הפד (מדבקה) היחידה עם מערכת אוטומטית היברידית. ללא צינוריות כלל.',
    pros: [
      'ללא צינורית (Tubeless) - חופש תנועה מלא',
      'אלגוריתם לומד ומתאים את עצמו בכל החלפת פוד',
      'תואמת Dexcom G6/G7 ו-Libre 2+',
      'אפליקציה מלאה לטלפונים תואמים'
    ],
    cons: [
      'אין בולוסים אוטומטיים לתיקון (רק הגברת בזאל)',
      'פחות אגרסיבית בתיקון סוכר גבוה מאוד'
    ]
  },
  ilet: {
    id: 'ilet',
    name: 'iLet Bionic Pancreas',
    tagline: 'אוטונומיה מלאה',
    description: 'המערכת שעושה הכל לבד. אין צורך לספור פחמימות או לקבוע הגדרות בסיס.',
    pros: [
      'אין ספירת פחמימות! (רק "ארוחה רגילה/גדולה/קטנה")',
      'לא דורשת הגדרת בזאל או רגישות',
      'לומדת את המטופל באופן מלא'
    ],
    cons: [
      'אי אפשר לשנות הגדרות ידנית אם רוצים',
      'יעדי סוכר קבועים (רגיל, נמוך, גבוה)'
    ]
  },
  twiist: {
    id: 'twiist',
    name: 'twiist (Tidepool)',
    tagline: 'גמישות בבחירה',
    description: 'מערכת המבוססת על אפליקציית Tidepool Loop, מאפשרת בחירה רחבה של סנסורים והגדרות.',
    pros: [
      'תמיכה רחבה בסנסורים (כולל Libre 3, Eversense)',
      'שליטה מאפל ווטש (Apple Watch)',
      'אלגוריתם המכוון לערך ספציפי ולא לטווח'
    ],
    cons: [
      'מחייבת שימוש ב-iPhone (נכון להיום)',
      'דורשת הבנה טכנולוגית מסוימת'
    ]
  }
};

// Questions & Scoring Logic
const QUESTIONS = [
  {
    id: 'tubing',
    text: 'מהי ההעדפה שלך לגבי חיבור המשאבה לגוף?',
    options: [
      {
        text: 'חשוב לי מאוד להיות בלי צינורית בכלל (משאבת מדבקה)',
        score: { omnipod: 10, medtronic: -2, tandem: -2, ilet: -2, twiist: -2 }
      },
      {
        text: 'אין לי בעיה עם צינורית, כל עוד המשאבה חכמה',
        score: { medtronic: 3, tandem: 3, ilet: 3, twiist: 3, omnipod: 0 }
      },
      {
        text: 'מעדיף צינורית קצרה או משאבה זעירה שניתן להסתיר',
        score: { tandem: 5, twiist: 3, medtronic: 1, omnipod: -1 } // Tandem Mobi specific
      }
    ]
  },
  {
    id: 'cgm',
    text: 'באיזה מד סוכר רציף (סנסור) אתה משתמש כיום או מעדיף?',
    options: [
      {
        text: 'Dexcom G6 / G7',
        score: { tandem: 5, omnipod: 5, ilet: 5, twiist: 5, medtronic: -10 }
      },
      {
        text: 'Guardian 4 / Simplera',
        score: { medtronic: 10, tandem: -5, omnipod: -5, ilet: -5, twiist: -5 }
      },
      {
        text: 'Freestyle Libre 2 Plus / 3',
        score: { tandem: 3, omnipod: 3, twiist: 5, ilet: 3, medtronic: -5 }
      },
      {
        text: 'לא משנה לי / מוכן להחליף',
        score: { medtronic: 2, tandem: 2, omnipod: 2, ilet: 2, twiist: 2 }
      }
    ]
  },
  {
    id: 'control',
    text: 'האם חשוב לך לשלוט על המשאבה (לתת בולוסים) מהטלפון הנייד?',
    options: [
      {
        text: 'כן, זה קריטי לי. הטלפון הוא השלט שלי',
        score: { tandem: 5, omnipod: 5, twiist: 5, medtronic: -2, ilet: 2 }
      },
      {
        text: 'לא קריטי, מסתדר עם מסך המשאבה',
        score: { medtronic: 3, tandem: 1, omnipod: 0, ilet: 1, twiist: 1 }
      }
    ]
  },
  {
    id: 'automation_style',
    text: 'כמה "אגרסיבית" תרצה שהמערכת תהיה בתיקון סוכר גבוה?',
    options: [
      {
        text: 'אגרסיבית מאוד. תן לי תיקונים אוטומטיים כל כמה דקות',
        score: { medtronic: 8, ilet: 6, tandem: 2, omnipod: -3, twiist: 0 }
      },
      {
        text: 'עדינה. תעלה את הרקע (בזאל) אבל אל תתן מנות גדולות לבד',
        score: { omnipod: 5, tandem: 3, twiist: 3, medtronic: -2, ilet: -2 }
      }
    ]
  },
  {
    id: 'carbs',
    text: 'איך אתה מסתדר עם ספירת פחמימות?',
    options: [
      {
        text: 'אני שונא לספור. מעדיף רק להגיד "ארוחה רגילה/גדולה"',
        score: { ilet: 15, medtronic: -2, tandem: -2, omnipod: -2, twiist: -2 }
      },
      {
        text: 'אני סופר מדויק ורוצה שליטה על המינון',
        score: { medtronic: 2, tandem: 5, omnipod: 5, twiist: 5, ilet: -5 }
      }
    ]
  }
];

// --- COMPONENTS ---

export default function PumpMatcherApp() {
  const [started, setStarted] = useState(false);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [scores, setScores] = useState({
    medtronic: 0,
    tandem: 0,
    omnipod: 0,
    ilet: 0,
    twiist: 0
  });
  const [finished, setFinished] = useState(false);
  const [history, setHistory] = useState([]); // Track user choices for summary

  const handleStart = () => setStarted(true);

  const handleAnswer = (option) => {
    // 1. Update Scores
    const newScores = { ...scores };
    Object.keys(option.score).forEach(pumpKey => {
      newScores[pumpKey] += option.score[pumpKey];
    });
    setScores(newScores);

    // 2. Track History
    const currentQ = QUESTIONS[currentQuestionIndex];
    setHistory([...history, { question: currentQ.text, answer: option.text }]);

    // 3. Move Next or Finish
    if (currentQuestionIndex < QUESTIONS.length - 1) {
      setCurrentQuestionIndex(currentQuestionIndex + 1);
    } else {
      setFinished(true);
    }
  };

  const resetQuiz = () => {
    setStarted(false);
    setCurrentQuestionIndex(0);
    setScores({ medtronic: 0, tandem: 0, omnipod: 0, ilet: 0, twiist: 0 });
    setFinished(false);
    setHistory([]);
  };

  if (!started) {
    return <WelcomeScreen onStart={handleStart} />;
  }

  if (finished) {
    return <ResultScreen scores={scores} history={history} onReset={resetQuiz} />;
  }

  return (
    <QuestionScreen 
      question={QUESTIONS[currentQuestionIndex]} 
      total={QUESTIONS.length}
      current={currentQuestionIndex + 1}
      onAnswer={handleAnswer}
    />
  );
}

// 1. Welcome Screen
function WelcomeScreen({ onStart }) {
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4" dir="rtl">
      <div className="bg-white max-w-lg w-full rounded-2xl shadow-xl p-8 text-center">
        <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
          <Activity className="w-10 h-10 text-blue-600" />
        </div>
        <h1 className="text-3xl font-bold text-gray-800 mb-4">המצפן לבחירת משאבה</h1>
        <p className="text-gray-600 mb-8 text-lg">
          כלי עזר לקבלת החלטות למטופלי סוכרת סוג 1.
          <br/>
          ענה על 5 שאלות קצרות וקבל המלצה המותאמת לאורח החיים ולהעדפות הרפואיות שלך.
        </p>
        
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-8 text-sm text-yellow-800 text-right">
          <strong>שים לב:</strong> הכלי נועד למטרות הסברה בלבד ואינו מחליף ייעוץ רפואי מקצועי.
        </div>

        <button 
          onClick={onStart}
          className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg flex items-center justify-center gap-2"
        >
          בוא נתחיל
          <ChevronLeft className="w-5 h-5" />
        </button>
      </div>
    </div>
  );
}

// 2. Question Screen
function QuestionScreen({ question, total, current, onAnswer }) {
  const progress = (current / total) * 100;

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4" dir="rtl">
      <div className="w-full max-w-xl">
        {/* Progress Bar */}
        <div className="mb-8">
          <div className="flex justify-between text-sm text-gray-500 mb-2">
            <span>שאלה {current} מתוך {total}</span>
            <span>{Math.round(progress)}%</span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2.5">
            <div 
              className="bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-out" 
              style={{ width: `${progress}%` }}
            ></div>
          </div>
        </div>

        {/* Question Card */}
        <div className="bg-white rounded-2xl shadow-lg p-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-8 leading-relaxed">
            {question.text}
          </h2>

          <div className="space-y-4">
            {question.options.map((option, idx) => (
              <button
                key={idx}
                onClick={() => onAnswer(option)}
                className="w-full text-right p-5 rounded-xl border-2 border-gray-100 hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 group flex items-center justify-between"
              >
                <span className="text-lg text-gray-700 group-hover:text-blue-700 font-medium">
                  {option.text}
                </span>
                <div className="w-6 h-6 rounded-full border-2 border-gray-300 group-hover:border-blue-500 flex items-center justify-center">
                   <div className="w-3 h-3 rounded-full bg-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                </div>
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// 3. Result Screen
function ResultScreen({ scores, history, onReset }) {
  // Sort pumps by score
  const sortedPumps = Object.entries(scores)
    .sort(([, a], [, b]) => b - a)
    .map(([key]) => PUMPS[key]);

  const topMatch = sortedPumps[0];
  const runnerUp = sortedPumps[1];

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4" dir="rtl">
      <div className="max-w-3xl mx-auto">
        <h1 className="text-3xl font-bold text-center text-gray-800 mb-8">התוצאות שלך</h1>

        {/* Top Match Card */}
        <div className="bg-white rounded-2xl shadow-xl overflow-hidden mb-8 border-t-4 border-blue-600">
          <div className="bg-blue-50 p-6 flex items-center justify-between flex-wrap gap-4">
            <div>
              <span className="text-blue-600 font-bold uppercase tracking-wider text-sm">ההתאמה המובילה</span>
              <h2 className="text-3xl font-extrabold text-gray-900 mt-1">{topMatch.name}</h2>
              <p className="text-blue-800 mt-1 font-medium">{topMatch.tagline}</p>
            </div>
            <div className="bg-white p-3 rounded-full shadow-sm">
              <CheckCircle className="w-8 h-8 text-green-500" />
            </div>
          </div>
          
          <div className="p-8">
            <p className="text-lg text-gray-700 mb-6 leading-relaxed">
              {topMatch.description}
            </p>
            
            <div className="grid md:grid-cols-2 gap-8">
              <div>
                <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                  <Heart className="w-5 h-5 text-green-600" />
                  למה זה מתאים לך?
                </h3>
                <ul className="space-y-2">
                  {topMatch.pros.map((pro, i) => (
                    <li key={i} className="flex items-start gap-2 text-gray-600 text-sm">
                      <span className="mt-1.5 w-1.5 h-1.5 bg-green-500 rounded-full flex-shrink-0" />
                      {pro}
                    </li>
                  ))}
                </ul>
              </div>

              <div>
                <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                  <AlertCircle className="w-5 h-5 text-orange-500" />
                  נקודות למחשבה
                </h3>
                <ul className="space-y-2">
                  {topMatch.cons.map((con, i) => (
                    <li key={i} className="flex items-start gap-2 text-gray-600 text-sm">
                      <span className="mt-1.5 w-1.5 h-1.5 bg-orange-400 rounded-full flex-shrink-0" />
                      {con}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>
        </div>

        {/* Runner Up */}
        <div className="bg-white rounded-2xl shadow-md p-6 mb-8 opacity-90">
           <div className="flex items-center gap-3 mb-4">
             <div className="bg-gray-100 p-2 rounded-lg">
               <Settings className="w-6 h-6 text-gray-600" />
             </div>
             <div>
               <h3 className="text-xl font-bold text-gray-800">אפשרות שנייה: {runnerUp.name}</h3>
               <p className="text-sm text-gray-500">{runnerUp.tagline}</p>
             </div>
           </div>
           <p className="text-gray-600 text-sm mb-4">{runnerUp.description}</p>
           <div className="text-sm text-blue-600 font-medium cursor-pointer hover:underline">
             + יתרון מרכזי: {runnerUp.pros[0]}
           </div>
        </div>

        {/* Summary of choices */}
        <div className="bg-gray-100 rounded-xl p-6 mb-8 text-sm">
          <h4 className="font-bold text-gray-700 mb-4">סיכום התשובות שלך:</h4>
          <ul className="space-y-2">
            {history.map((item, i) => (
              <li key={i} className="flex justify-between border-b border-gray-200 pb-2 last:border-0">
                <span className="text-gray-500">{item.question}</span>
                <span className="text-gray-800 font-medium text-left mr-4">{item.answer}</span>
              </li>
            ))}
          </ul>
        </div>

        <div className="flex flex-col gap-4">
          <button 
            onClick={() => window.print()}
            className="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50 transition-colors"
          >
            הדפס / שמור כ-PDF
          </button>
          
          <button 
            onClick={onReset}
            className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors"
          >
            התחל מחדש
          </button>
        </div>

      </div>
    </div>
  );
}
